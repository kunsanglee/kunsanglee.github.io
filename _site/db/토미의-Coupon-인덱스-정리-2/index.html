<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.20.2 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="ko" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>토미의 Coupon 인덱스 정리 - 2 -  kunsanglee’s</title>
<meta name="description" content="3번 문제">


  <meta name="author" content="이건상">
  
  <meta property="article:author" content="이건상">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="ko_KR">
<meta property="og:site_name" content=" kunsanglee's">
<meta property="og:title" content="토미의 Coupon 인덱스 정리 - 2">
<meta property="og:url" content="http://localhost:4000/db/%ED%86%A0%EB%AF%B8%EC%9D%98-Coupon-%EC%9D%B8%EB%8D%B1%EC%8A%A4-%EC%A0%95%EB%A6%AC-2/">


  <meta property="og:description" content="3번 문제">







  <meta property="article:published_time" content="2024-08-30T00:00:00+09:00">





  

  


<link rel="canonical" href="http://localhost:4000/db/%ED%86%A0%EB%AF%B8%EC%9D%98-Coupon-%EC%9D%B8%EB%8D%B1%EC%8A%A4-%EC%A0%95%EB%A6%AC-2/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Kunsang Lee",
      "url": "http://localhost:4000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title=" kunsanglee's Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->
<meta name="naver-site-verification" content="d884164c2f43b5d7cfca36d514355ee3ab493511" />
<meta name="NaverBot" content="All"/>
<meta name="NaverBot" content="index,follow"/>
<meta name="Yeti" content="All"/>
<meta name="Yeti" content="index,follow"/>
<!-- insert favicons. use https://realfavicongenerator.net/ -->
<!--<link rel="apple-touch-icon" sizes="180x180" href="/assets/logo.ico/apple-touch-icon.png">-->
<!--<link rel="icon" type="image/png" sizes="32x32" href="/assets/logo.ico/favicon-32x32.png">-->
<!--<link rel="icon" type="image/png" sizes="16x16" href="/assets/logo.ico/favicon-16x16.png">-->
<!--<link rel="mask-icon" href="/assets/logo.ico/safari-pinned-tab.svg" color="#5bbad5">-->
<!--<meta name="msapplication-TileColor" content="#da532c">-->
<!--<meta name="theme-color" content="#ffffff">-->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
           kunsanglee's
          <span class="site-subtitle">backend</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/">Home</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/">Category</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/">Tags</a>
            </li><li class="masthead__menu-item">
              <a href="/year-archive/">Year</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">토글 메뉴</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/image/profile/%EC%9A%9C%EC%9D%B4.png" alt="이건상" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">이건상</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>basic is everything</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">팔로우</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Republic of Korea</span>
        </li>
      

      
        
          
            <li><a href="mailto:gosmdochee2@gmail.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://github.com/kunsanglee" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
          
        
          
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="토미의 Coupon 인덱스 정리 - 2">
    <meta itemprop="description" content="3번 문제">
    <meta itemprop="datePublished" content="2024-08-30T00:00:00+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">토미의 Coupon 인덱스 정리 - 2
</h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          9 분 소요
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On This Page</h4></header>
              <ul class="toc__menu">
  <li><a href="#3번-문제">3번 문제</a>
    <ul>
      <li><a href="#couponcontroller">CouponController</a></li>
      <li><a href="#couponservice">CouponService</a></li>
      <li><a href="#couponrepository">CouponRepository</a></li>
      <li><a href="#couponstatus">CouponStatus</a></li>
      <li><a href="#sql-쿼리-예상">SQL 쿼리 예상</a></li>
      <li><a href="#인덱스-분석">인덱스 분석</a></li>
      <li><a href="#실행-계획-분석">실행 계획 분석</a></li>
      <li><a href="#table-scan을-통한-성능-테스트-결과">Table scan을 통한 성능 테스트 결과</a></li>
      <li><a href="#조건절에-포함된-매개변수-인덱스-설정">조건절에 포함된 매개변수 인덱스 설정</a></li>
      <li><a href="#explain">explain</a></li>
      <li><a href="#using-index와-using-index-condition의-차이점">Using index와 Using index condition의 차이점</a></li>
      <li><a href="#expain-analyze">expain analyze</a></li>
      <li><a href="#커버링-인덱스를-통한-성능-테스트-결과">커버링 인덱스를 통한 성능 테스트 결과</a></li>
      <li><a href="#그런데-조건-인덱스-조건index-condition은-무슨-차이가-있을까">그런데 조건, 인덱스 조건(index condition)은 무슨 차이가 있을까?</a></li>
      <li><a href="#조건where과-인덱스-조건index-condition">조건(where)과 인덱스 조건(Index condition)</a></li>
      <li><a href="#조건의-종류">조건의 종류</a></li>
      <li><a href="#적용-과정">적용 과정</a></li>
      <li><a href="#최종-결과">최종 결과</a></li>
      <li><a href="#cardinality-고려한-인덱스-컬럼-순서">Cardinality 고려한 인덱스 컬럼 순서</a></li>
      <li><a href="#explain-1">explain</a></li>
      <li><a href="#explain-analyze">explain analyze</a></li>
      <li><a href="#범위-조건-우선하여-인덱스-설정하고-성능-테스트">범위 조건 우선하여 인덱스 설정하고 성능 테스트</a></li>
      <li><a href="#효율이-떨어진-이유">효율이 떨어진 이유</a></li>
      <li><a href="#쿼리에서-사용된-모든-컬럼에-대한-인덱스를-만드는-것이-좋을까">쿼리에서 사용된 모든 컬럼에 대한 인덱스를 만드는 것이 좋을까?</a></li>
      <li><a href="#여러-컬럼으로-인덱스-설정-시-조건-누락">여러 컬럼으로 인덱스 설정 시 조건 누락</a></li>
    </ul>
  </li>
</ul>

            </nav>
          </aside>
        
        <h2 id="3번-문제">3번 문제</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>  
<span class="kt">void</span> <span class="n">현재_발급_가능한_쿠폰_조회</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>  
    <span class="nc">AtomicBoolean</span> <span class="n">running</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicBoolean</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>  
    <span class="nc">AtomicInteger</span> <span class="n">requestCount</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>  
    <span class="nc">AtomicLong</span> <span class="n">totalElapsedTime</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicLong</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>  
  
    <span class="kt">int</span> <span class="n">statusCode</span> <span class="o">=</span> <span class="nc">RestAssured</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"/coupons/issuable"</span><span class="o">).</span><span class="na">statusCode</span><span class="o">();</span>  
    <span class="n">assertThat</span><span class="o">(</span><span class="n">statusCode</span><span class="o">).</span><span class="na">withFailMessage</span><span class="o">(</span><span class="s">"발급 가능한 쿠폰 조회 API 호출에 실패했습니다. 테스트 대상 서버가 실행중인지 확인해 주세요."</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">200</span><span class="o">);</span>  
  
    <span class="n">executeMultipleRequests</span><span class="o">(</span><span class="n">running</span><span class="o">,</span> <span class="n">requestCount</span><span class="o">,</span> <span class="n">totalElapsedTime</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="nc">RestAssured</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"/coupons/issuable"</span><span class="o">));</span>  
  
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Total request count: "</span> <span class="o">+</span> <span class="n">requestCount</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>  
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Total elapsed time: "</span> <span class="o">+</span> <span class="n">totalElapsedTime</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">+</span> <span class="s">"ms"</span><span class="o">);</span>  
  
    <span class="kt">long</span> <span class="n">averageElapsedTime</span> <span class="o">=</span> <span class="n">totalElapsedTime</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">/</span> <span class="n">requestCount</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>  
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Average elapsed time: "</span> <span class="o">+</span> <span class="n">totalElapsedTime</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">/</span> <span class="n">requestCount</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">+</span> <span class="s">"ms"</span><span class="o">);</span>  
  
    <span class="n">assertThat</span><span class="o">(</span><span class="n">averageElapsedTime</span><span class="o">).</span><span class="na">isLessThanOrEqualTo</span><span class="o">(</span><span class="mi">500L</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>3번 문제는 현재 발급 가능한 쿠폰을 조회하는 API 테스트이다. 호출하는 메서드를 살펴보자.</p>

<h3 id="couponcontroller">CouponController</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// CouponController.class</span>
<span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/issuable"</span><span class="o">)</span>  
<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">CouponResponse</span><span class="o">&gt;</span> <span class="nf">findIssuableCoupons</span><span class="o">()</span> <span class="o">{</span>  
    <span class="k">return</span> <span class="n">couponService</span><span class="o">.</span><span class="na">findIssuableCoupons</span><span class="o">().</span><span class="na">stream</span><span class="o">()</span>  
            <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">CouponResponse:</span><span class="o">:</span><span class="n">from</span><span class="o">)</span>  
            <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">toList</span><span class="o">());</span>  
<span class="o">}</span>
</code></pre></div></div>

<h3 id="couponservice">CouponService</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// CouponService.class</span>
<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Coupon</span><span class="o">&gt;</span> <span class="nf">findIssuableCoupons</span><span class="o">()</span> <span class="o">{</span>  
    <span class="nc">LocalDateTime</span> <span class="n">now</span> <span class="o">=</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>  
    <span class="k">return</span> <span class="n">couponRepository</span><span class="o">.</span><span class="na">findAllByIssuableAndCouponStatusAndIssueStartedAtLessThanAndIssueEndedAtGreaterThan</span><span class="o">(</span>  
                    <span class="kc">true</span><span class="o">,</span> <span class="nc">CouponStatus</span><span class="o">.</span><span class="na">ISSUABLE</span><span class="o">,</span> <span class="n">now</span><span class="o">,</span> <span class="n">now</span><span class="o">).</span><span class="na">stream</span><span class="o">()</span>  
            <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">coupon</span> <span class="o">-&gt;</span> <span class="n">coupon</span><span class="o">.</span><span class="na">isIssuableCoupon</span><span class="o">(</span><span class="n">now</span><span class="o">))</span>  
            <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">toList</span><span class="o">());</span>  
<span class="o">}</span>
</code></pre></div></div>

<h3 id="couponrepository">CouponRepository</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// CouponRepository.class</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Coupon</span><span class="o">&gt;</span> <span class="nf">findAllByIssuableAndCouponStatusAndIssueStartedAtLessThanAndIssueEndedAtGreaterThan</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">issuable</span><span class="o">,</span> <span class="nc">CouponStatus</span> <span class="n">couponStatus</span><span class="o">,</span> <span class="nc">LocalDateTime</span> <span class="n">issueStartedAt</span><span class="o">,</span> <span class="nc">LocalDateTime</span> <span class="n">issueEndedAt</span><span class="o">);</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">findAllByIssuableAndCouponStatusAndIssueStartedAtLessThanAndIssueEndedAtGreaterThan</code> 메서드는 발급 가능한지 여부를 나타내는 <code class="language-plaintext highlighter-rouge">issuable</code>, 쿠폰의 상태를 나타내는 <code class="language-plaintext highlighter-rouge">CouponStatus</code>, 쿠폰의 유효 시작기간 <code class="language-plaintext highlighter-rouge">issueStartedAt</code>과 만료기간 <code class="language-plaintext highlighter-rouge">issueEndedAt</code>을 매개변수로 받아서 쿠폰 리스트를 조회한다.</p>

<h3 id="couponstatus">CouponStatus</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">enum</span> <span class="nc">CouponStatus</span> <span class="o">{</span>  
    <span class="no">PREPARING</span><span class="o">,</span>  
    <span class="no">ISSUABLE</span><span class="o">,</span>  
    <span class="no">EXPIRED</span><span class="o">,</span>  
    <span class="no">DISCARDED</span>  
    <span class="o">;</span>  
  
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isNotIssuable</span><span class="o">()</span> <span class="o">{</span>  
        <span class="k">return</span> <span class="k">this</span> <span class="o">!=</span> <span class="no">ISSUABLE</span><span class="o">;</span>  
    <span class="o">}</span>  
  
    <span class="cm">/**  
     * 폐기된 쿠폰은 사용할 수 없다.
     */</span>    
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isNotUsable</span><span class="o">()</span> <span class="o">{</span>  
        <span class="k">return</span> <span class="k">this</span> <span class="o">==</span> <span class="no">PREPARING</span> <span class="o">||</span> <span class="k">this</span> <span class="o">==</span> <span class="no">DISCARDED</span><span class="o">;</span>  
    <span class="o">}</span>  
<span class="o">}</span>
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">CouponStatus</code> enum은 이런 값들을 가지고 있다.</p>

<h3 id="sql-쿼리-예상">SQL 쿼리 예상</h3>
<p><code class="language-plaintext highlighter-rouge">findAllByIssuableAndCouponStatusAndIssueStartedAtLessThanAndIssueEndedAtGreaterThan</code> 메서드를 사용해서 만료된 쿠폰들을 조회한다고 가정하고, 해당 메서드를 sql 쿼리로 작성해보면 이런 식이다.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">coupon</span> <span class="k">c</span>
<span class="k">where</span> <span class="k">c</span><span class="p">.</span><span class="n">issuable</span> <span class="o">=</span> <span class="k">false</span>
<span class="k">and</span> <span class="k">c</span><span class="p">.</span><span class="n">coupon_status</span> <span class="o">=</span> <span class="s1">'EXPIRED'</span>  
<span class="k">and</span> <span class="k">c</span><span class="p">.</span><span class="n">issue_started_at</span> <span class="o">&lt;</span> <span class="s1">'2019-02-01 00:00:00.000000'</span>  
<span class="k">and</span> <span class="k">c</span><span class="p">.</span><span class="n">issue_ended_at</span> <span class="o">&gt;</span> <span class="s1">'2019-01-01 00:00:00.00000'</span><span class="p">;</span>
</code></pre></div></div>

<blockquote>
  <p>query creation으로 작성된 부분 중에 <code class="language-plaintext highlighter-rouge">IusseStartedAtLessThan</code>, <code class="language-plaintext highlighter-rouge">IssueEndedAtGreaterThan</code> 부분으로 인해 약간 날짜 값이 반대로 뒤집혀있는 느낌이 든다. 마치 젓가락질을 X자로 하는 듯 한..? 개인적인 생각으로 <code class="language-plaintext highlighter-rouge">IssueStartedAtGreaterThanOrEqual</code>, <code class="language-plaintext highlighter-rouge">IssueEndedAtLessThanOrEqual</code> 이런 식으로 작성하는 것이 가독성이 더 좋을 거라고 생각한다.</p>
</blockquote>

<h3 id="인덱스-분석">인덱스 분석</h3>

<p><code class="language-plaintext highlighter-rouge">coupon</code> 테이블의 인덱스를 살펴보면<code class="language-plaintext highlighter-rouge">coupon_id</code> <code class="language-plaintext highlighter-rouge">PRIMARY</code> 키를 제외한 어떠한 인덱스도 없다.</p>

<p><img src="/image/for-post/tommy-index/Pasted image 20240830143759.png" alt="[Pasted image 20240830143759.png]" /></p>

<h3 id="실행-계획-분석">실행 계획 분석</h3>

<p>해당 쿼리를 <code class="language-plaintext highlighter-rouge">explain</code>을 통해서 살펴보자.</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">coupon</span> <span class="k">c</span>
<span class="k">where</span> <span class="k">c</span><span class="p">.</span><span class="n">issuable</span> <span class="o">=</span> <span class="k">false</span>
<span class="k">and</span> <span class="k">c</span><span class="p">.</span><span class="n">coupon_status</span> <span class="o">=</span> <span class="s1">'EXPIRED'</span>  
<span class="k">and</span> <span class="k">c</span><span class="p">.</span><span class="n">issue_started_at</span> <span class="o">&lt;</span> <span class="s1">'2019-02-01 00:00:00.000000'</span>  
<span class="k">and</span> <span class="k">c</span><span class="p">.</span><span class="n">issue_ended_at</span> <span class="o">&gt;</span> <span class="s1">'2019-01-01 00:00:00.00000'</span><span class="p">;</span>
</code></pre></div></div>

<p><img src="/image/for-post/tommy-index/Pasted image 20240830143842.png" alt="[Pasted image 20240830143842.png]" /></p>

<p>실행 계획을 보면 해당 쿼리는 조건절에 <code class="language-plaintext highlighter-rouge">coupon_id</code>를 포함하지 않기 때문에 인덱스를 사용하지 않는다. <code class="language-plaintext highlighter-rouge">type</code>는 <code class="language-plaintext highlighter-rouge">ALL</code>, <code class="language-plaintext highlighter-rouge">key</code>는 <code class="language-plaintext highlighter-rouge">null</code>, <code class="language-plaintext highlighter-rouge">filtered</code>는 <code class="language-plaintext highlighter-rouge">0.11</code>, <code class="language-plaintext highlighter-rouge">Extra</code>는 <code class="language-plaintext highlighter-rouge">Using where</code>다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-&gt; Filter: ((c.coupon_status = 'EXPIRED') and (c.issuable = false) and (c.issue_started_at &lt; TIMESTAMP'2019-02-01 00:00:00') and (c.issue_ended_at &gt; TIMESTAMP'2019-01-01 00:00:00'))  (cost=32839 rows=357) (actual time=3.52..174 rows=8 loops=1)
    -&gt; Table scan on c  (cost=32839 rows=321576) (actual time=3.4..142 rows=351160 loops=1)
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">explain analyze</code> 결과를 분석해보면 filter 조건으로 쿠폰의 상태, 발행 가능한지, 발행 시작일과 만료일 4개의 조건으로 조회했고, 실제 실행 시간은 3.52ms에서 174ms 사이였고, 비용은 32,839가 나왔다. 인덱스를 사용하지 않은 <code class="language-plaintext highlighter-rouge">Table scan</code>이 이루어졌고, 전체 351,160 행 중에서 필터 조건에 만족될 것으로 예상되는 행 수는 321,576행이다. 여기서 중요한 점은 <strong>예상되는 321,576행 중 실제로 조건에 맞는 행은 8개의 행</strong>만 남았다는 것이다.</p>

<p><strong>예상 행 수와 실제 결과의 차이가 많이 난다는 것</strong>은 인덱스 사용이나 쿼리 조건을 재검토하여 성능을 개선할 필요가 있다는 것을 의미한다.</p>

<h3 id="table-scan을-통한-성능-테스트-결과">Table scan을 통한 성능 테스트 결과</h3>

<p>인덱스가 아닌 <code class="language-plaintext highlighter-rouge">Table scan</code>을 통해 주어진 테스트를 돌려보고 요청 당 평균 소요시간을 살펴보면 이런 결과가 나온다.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Total</span> <span class="n">request</span> <span class="nl">count:</span> <span class="mi">471</span>
<span class="nc">Total</span> <span class="n">elapsed</span> <span class="nl">time:</span> <span class="mi">100600</span><span class="n">ms</span>
<span class="nc">Average</span> <span class="n">elapsed</span> <span class="nl">time:</span> <span class="mi">213</span><span class="n">ms</span>
</code></pre></div></div>

<h3 id="조건절에-포함된-매개변수-인덱스-설정">조건절에 포함된 매개변수 인덱스 설정</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">coupon</span> <span class="k">c</span>
<span class="k">where</span> <span class="k">c</span><span class="p">.</span><span class="n">issuable</span> <span class="o">=</span> <span class="k">false</span>
<span class="k">and</span> <span class="k">c</span><span class="p">.</span><span class="n">coupon_status</span> <span class="o">=</span> <span class="s1">'EXPIRED'</span>  
<span class="k">and</span> <span class="k">c</span><span class="p">.</span><span class="n">issue_started_at</span> <span class="o">&lt;</span> <span class="s1">'2019-02-01 00:00:00.000000'</span>  
<span class="k">and</span> <span class="k">c</span><span class="p">.</span><span class="n">issue_ended_at</span> <span class="o">&gt;</span> <span class="s1">'2019-01-01 00:00:00.00000'</span><span class="p">;</span>
</code></pre></div></div>

<p>조건절에 포함된 4가지 컬럼에 인덱스를 설정한다.</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">index</span> <span class="n">idx_issuable_coupon_status_issue_started_at_issue_ended_at</span> <span class="k">on</span> <span class="n">coupon</span> <span class="p">(</span><span class="n">issuable</span><span class="p">,</span> <span class="n">coupon_status</span><span class="p">,</span> <span class="n">issue_started_at</span><span class="p">,</span> <span class="n">issue_ended_at</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="/image/for-post/tommy-index/Pasted image 20240830151003.png" alt="[Pasted image 20240830151003.png]" /></p>

<h3 id="explain">explain</h3>

<p><img src="/image/for-post/tommy-index/Pasted image 20240830151049.png" alt="[Pasted image 20240830151049.png]" /></p>

<div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| #  | id | select_type | table | partitions | type  | possible_keys                                      | key                                               | key_len | ref | rows | filtered | Extra                    |
|----|----|-------------|-------|------------|-------|---------------------------------------------------|---------------------------------------------------|---------|-----|------|----------|--------------------------|
| 1  | 1  | SIMPLE      | c     |            | range | idx_issuable_coupon_status_issue_started_at_issue_ended_at | idx_issuable_coupon_status_issue_started_at_issue_ended_at | 134     |     | 8    | 33.33    | Using index condition     |
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">type</code>은 <code class="language-plaintext highlighter-rouge">range</code>로 인덱스를 사용하여 범위 검색을 하도록 변경되었고, <code class="language-plaintext highlighter-rouge">key</code>로는 방금 만든 인덱스를 사용하고 있다. <code class="language-plaintext highlighter-rouge">filtered</code>는 <code class="language-plaintext highlighter-rouge">33.33%</code>, <code class="language-plaintext highlighter-rouge">Extra</code>는 <code class="language-plaintext highlighter-rouge">Using index condition</code>이 되었다. <code class="language-plaintext highlighter-rouge">Using index</code>는 봤었는데, <code class="language-plaintext highlighter-rouge">Using index condition</code>은 뭘까?</p>

<h3 id="using-index와-using-index-condition의-차이점"><code class="language-plaintext highlighter-rouge">Using index</code>와 <code class="language-plaintext highlighter-rouge">Using index condition</code>의 차이점</h3>
<p><code class="language-plaintext highlighter-rouge">Using index</code>와 <code class="language-plaintext highlighter-rouge">Using index condition</code>은 두 가지 다른 인덱스 사용 방식이다.</p>

<ol>
  <li>
    <p><strong>Using index</strong>:</p>

    <ul>
      <li>쿼리가 인덱스를 사용하여 데이터를 검색하고, 인덱스에서 직접 필요한 데이터를 가져오는 경우이다. 이 경우, 테이블의 데이터 페이지를 읽지 않고, 다시 말해서 <strong>데이터가 있는 테이블에 직접 접근하지 않고 인덱스만으로 쿼리를 처리할 수 있어 성능이 향상</strong>된다.</li>
    </ul>
  </li>
  <li>
    <p><strong>Using index condition</strong>:</p>

    <ul>
      <li><strong>인덱스를 사용하여 조건을 평가</strong>하는 경우입니다. 즉, 인덱스의 값을 기반으로 특정 조건을 필터링하는 과정을 포함합니다. 이 경우, 인덱스가 적용되지만, <strong>최종적으로 조건에 맞는 데이터를 찾기 위해 테이블의 데이터 페이지를 읽어야 할 수도 있다</strong>.</li>
    </ul>
  </li>
</ol>

<h3 id="expain-analyze">expain analyze</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-&gt; Index range scan on c using idx_issuable_coupon_status_issue_started_at_issue_ended_at over (issuable = 0 AND coupon_status = 'EXPIRED' AND NULL &lt; issue_started_at &lt; '2019-02-01 00:00:00.000000'), with index condition: ((c.coupon_status = 'EXPIRED') and (c.issuable = false) and (c.issue_started_at &lt; TIMESTAMP'2019-02-01 00:00:00') and (c.issue_ended_at &gt; TIMESTAMP'2019-01-01 00:00:00'))  (cost=3.86 rows=8) (actual time=0.0441..0.09 rows=8 loops=1)
</code></pre></div></div>
<p>쿼리 실행 계획 분석을 보면 <code class="language-plaintext highlighter-rouge">Index range scan</code>을 하고있고, <strong>조건과 인덱스 조건</strong>이 각각 있다. 비용과 실제 실행 시간은 눈에 띄게 줄어들은 것을 확인할 수 있다.</p>

<h3 id="커버링-인덱스를-통한-성능-테스트-결과">커버링 인덱스를 통한 성능 테스트 결과</h3>

<p><code class="language-plaintext highlighter-rouge">issuable</code>, <code class="language-plaintext highlighter-rouge">coupon_status</code>, <code class="language-plaintext highlighter-rouge">issue_started_at</code>, <code class="language-plaintext highlighter-rouge">issue_ended_at</code> 컬럼 순서로 인덱스.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Total</span> <span class="n">request</span> <span class="nl">count:</span> <span class="mi">12853</span>
<span class="nc">Total</span> <span class="n">elapsed</span> <span class="nl">time:</span> <span class="mi">100049</span><span class="n">ms</span>
<span class="nc">Average</span> <span class="n">elapsed</span> <span class="nl">time:</span> <span class="mi">7</span><span class="n">ms</span>
</code></pre></div></div>

<h3 id="그런데-조건-인덱스-조건index-condition은-무슨-차이가-있을까">그런데 조건, 인덱스 조건(index condition)은 무슨 차이가 있을까?</h3>

<h3 id="조건where과-인덱스-조건index-condition">조건(where)과 인덱스 조건(Index condition)</h3>

<p>1.<strong>조건 (where 조건)</strong></p>

<ul>
  <li>쿼리에서 주로 <code class="language-plaintext highlighter-rouge">where</code>절에 명시되는 데이터를 필터링하기 위해 사용되는 조건이다. 예를 들어,<code class="language-plaintext highlighter-rouge">issuable = 0</code>이나<code class="language-plaintext highlighter-rouge">coupon_status = 'EXPIRED'</code>같은 조건이 여기에 해당한다. 데이터베이스가 검색해야 할 데이터를 제한하는 역할을 한다.</li>
</ul>

<p>2.<strong>인덱스 조건 (Index condition)</strong></p>

<ul>
  <li>인덱스를 사용할 때 적용되는 조건이다. 인덱스 조건은 인덱스를 통해 데이터 검색을 최적화하는 데 도움을 준다. 예를 들어,<code class="language-plaintext highlighter-rouge">c.coupon_status = 'EXPIRED'</code>와 같은 조건이 인덱스를 기반으로 필터링할 때 사용된다. 인덱스를 통해 더 빠르게 데이터를 찾고, 검색 성능을 향상시키는 역할을 한다.</li>
</ul>

<p>결과적으로 위 쿼리와 인덱스 설정으로 인해, 4가지 컬럼 모두 where, index condition으로 적용된다. 그런데 <code class="language-plaintext highlighter-rouge">issuable</code>, <code class="language-plaintext highlighter-rouge">coupon_status</code> 컬럼의 경우 <code class="language-plaintext highlighter-rouge">대입 조건</code>이고, <code class="language-plaintext highlighter-rouge">issue_started_at</code>, <code class="language-plaintext highlighter-rouge">issue_ended_at</code> 컬럼의 경우 <code class="language-plaintext highlighter-rouge">범위 검색 조건</code>이다. 이 두 조건은 어떤 식으로 적용될까?</p>

<blockquote>
  <p><a href="https://dev.mysql.com/doc/refman/8.0/en/explain.html">MySQL EXPLAIN Documentation</a><br />
<a href="https://dev.mysql.com/doc/refman/8.0/en/optimization.html">MySQL 쿼리 최적화</a></p>
</blockquote>

<h3 id="조건의-종류">조건의 종류</h3>

<ol>
  <li>
    <p><strong>범위 검색 조건</strong></p>

    <ul>
      <li><strong>issue_started_at</strong>:<code class="language-plaintext highlighter-rouge">NULL &lt; issue_started_at &lt; '2019-02-01 00:00:00.000000'</code></li>
      <li><strong>issue_ended_at</strong>:<code class="language-plaintext highlighter-rouge">issue_ended_at &gt; TIMESTAMP '2019-01-01 00:00:00'</code></li>
      <li>이 조건들은 특정 범위 내의 값을 찾는 데 사용된다. 데이터베이스는 이 범위에 해당하는 날짜를 가진 행들을 검색한다.</li>
    </ul>
  </li>
  <li>
    <p><strong>대입 조건</strong></p>

    <ul>
      <li><strong>issuable = 0</strong>: 발행 가능한 쿠폰이 아닌 데이터 필터링.</li>
      <li><strong>coupon_status = ‘EXPIRED’</strong>: 쿠폰이 만료된 상태인 데이터 필터링.</li>
      <li>이 조건들은 특정 값을 가진 행들을 찾는 데 사용된다.</li>
    </ul>
  </li>
</ol>

<h3 id="적용-과정">적용 과정</h3>

<p>쿼리가 실행될 때, 다음과 같은 순서로 조건이 적용된다.</p>

<ol>
  <li>
    <p><strong>인덱스 활용</strong></p>

    <ul>
      <li>인덱스가 설정된 컬럼(예:<code class="language-plaintext highlighter-rouge">issuable</code>,<code class="language-plaintext highlighter-rouge">coupon_status</code>,<code class="language-plaintext highlighter-rouge">issue_started_at</code>,<code class="language-plaintext highlighter-rouge">issue_ended_at</code>)에 대해 인덱스 범위 스캔이 이루어진다.</li>
      <li>이 과정에서 인덱스 조건이 먼저 적용되어 인덱스를 통해 필터링된 데이터 집합이 생성된다.</li>
    </ul>
  </li>
  <li>
    <p><strong>범위 검색 조건 적용</strong></p>

    <ul>
      <li>인덱스를 통해 검색된 데이터에서 먼저 범위 검색 조건이 적용된다. 즉,<code class="language-plaintext highlighter-rouge">issue_started_at</code>과<code class="language-plaintext highlighter-rouge">issue_ended_at</code>의 범위에 맞는 행들이 필터링된다.</li>
    </ul>
  </li>
  <li>
    <p><strong>대입 조건 적용</strong></p>

    <ul>
      <li>이후, 범위 검색을 통과한 결과에서 대입 조건인<code class="language-plaintext highlighter-rouge">issuable</code>과<code class="language-plaintext highlighter-rouge">coupon_status</code>를 적용하여 최종적으로 조건을 만족하는 행들을 찾는다.</li>
    </ul>
  </li>
</ol>

<h3 id="최종-결과">최종 결과</h3>

<p><strong>인덱스를 사용하여 범위 조건으로 데이터를 축소한 후, 대입 조건을 통해 남은 데이터에서 최종적으로 반환할 행을 결정</strong>한다. 쿼리의 성능을 최적화하고, 필요 없는 데이터를 미리 걸러내는 효과가 있다.</p>

<h3 id="cardinality-고려한-인덱스-컬럼-순서">Cardinality 고려한 인덱스 컬럼 순서</h3>

<p><img src="/image/for-post/tommy-index/Pasted image 20240830151003.png" alt="[Pasted image 20240830151003.png]" /></p>

<p>그런데 위 index에서 <code class="language-plaintext highlighter-rouge">Cardinality</code> 부분을 자세히 살펴보면 이상하다. <code class="language-plaintext highlighter-rouge">issuable</code>, <code class="language-plaintext highlighter-rouge">coupon_status</code>, <code class="language-plaintext highlighter-rouge">issue_started_at</code>, <code class="language-plaintext highlighter-rouge">issue_ended_at</code> 순서로 인덱스가 걸려있는데, <code class="language-plaintext highlighter-rouge">Cardinality</code>는 시작, 만료 기간을 나타내는 컬럼이 앞의 두 컬럼보다 훨씬 높다. 그렇다면 인덱스가 필터링을 더 잘 수행하게 하기 위해 <code class="language-plaintext highlighter-rouge">issue_started_at</code>, <code class="language-plaintext highlighter-rouge">issue_ended_at</code>, <code class="language-plaintext highlighter-rouge">coupon_status</code>, <code class="language-plaintext highlighter-rouge">issuable</code> 순서로 인덱스를 생성하는 것이 더 좋지 않을까?</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">index</span> <span class="n">idx_issue_started_at_issue_ended_at_coupon_status_issuable</span>  
    <span class="k">on</span> <span class="n">coupon</span> <span class="p">(</span><span class="n">issue_started_at</span><span class="p">,</span> <span class="n">issue_ended_at</span><span class="p">,</span> <span class="n">coupon_status</span><span class="p">,</span> <span class="n">issuable</span><span class="p">);</span>
</code></pre></div></div>
<p>실험을 위해 새로운 인덱스를 <code class="language-plaintext highlighter-rouge">issue_started_at</code>, <code class="language-plaintext highlighter-rouge">issue_ended_at</code>, <code class="language-plaintext highlighter-rouge">coupon_status</code>, <code class="language-plaintext highlighter-rouge">issuable</code> 순서로 생성한다.</p>

<p><img src="/image/for-post/tommy-index/Pasted image 20240830162423.png" alt="[Pasted image 20240830162423.png]" /></p>

<p>이제 컬럼 순서가 다른 복합 인덱스 두 개가 생성되어 있다.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">explain</span> <span class="k">analyze</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">coupon</span> <span class="k">c</span> 
<span class="n">use</span> <span class="k">index</span> <span class="p">(</span><span class="n">idx_issue_started_at_issue_ended_at_coupon_status_issuable</span><span class="p">)</span>  
        <span class="k">where</span> <span class="k">c</span><span class="p">.</span><span class="n">issuable</span> <span class="o">=</span> <span class="k">false</span>  
          <span class="k">and</span> <span class="k">c</span><span class="p">.</span><span class="n">coupon_status</span> <span class="o">=</span> <span class="s1">'EXPIRED'</span>  
          <span class="k">and</span> <span class="k">c</span><span class="p">.</span><span class="n">issue_started_at</span> <span class="o">&lt;</span> <span class="s1">'2019-02-01 00:00:00.000000'</span>  
          <span class="k">and</span> <span class="k">c</span><span class="p">.</span><span class="n">issue_ended_at</span> <span class="o">&gt;</span> <span class="s1">'2019-01-01 00:00:00.00000'</span><span class="p">;</span>
</code></pre></div></div>

<p>이렇게 <code class="language-plaintext highlighter-rouge">from</code>절 뒤에 <code class="language-plaintext highlighter-rouge">use index (인덱스명)</code> 형태로 인덱스를 지정해주면 MySQL Optimizer가 cost 기반으로 최적의 선택을 하는 대신, 지정한 인덱스를 사용하도록 강제할 수 있다.</p>

<h3 id="explain-1">explain</h3>

<div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| #  | id | select_type | table | partitions | type  | possible_keys                                         | key                                                   | key_len | ref | rows | filtered | Extra                     |
|----|----|-------------|-------|------------|-------|------------------------------------------------------|------------------------------------------------------|---------|-----|------|----------|---------------------------|
| 1  | 1  | SIMPLE      | c     |            | range | idx_issue_started_at_issue_ended_at_coupon_status_issuable | idx_issue_started_at_issue_ended_at_coupon_status_issuable | 9       |     | 2180 | 3.33     | Using index condition      |

</code></pre></div></div>
<p>새로 만든 시작, 만료 기간이 우선으로 설정된 인덱스를 사용하고 있고, <code class="language-plaintext highlighter-rouge">type</code>은 <code class="language-plaintext highlighter-rouge">range</code>로 전과 똑같다. <code class="language-plaintext highlighter-rouge">filtered</code>가 <code class="language-plaintext highlighter-rouge">3.33%</code>로 이전의 커버링 인덱스와 비교하여 <code class="language-plaintext highlighter-rouge">1/10</code> 정도 떨어졌지만, 똑같은 <code class="language-plaintext highlighter-rouge">Extra</code> <code class="language-plaintext highlighter-rouge">Using index condition</code>인 것을 볼 수 있다.</p>

<h3 id="explain-analyze">explain analyze</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-&gt; Index range scan on c using idx_issue_started_at_issue_ended_at_coupon_status_issuable over (NULL &lt; issue_started_at &lt; '2019-02-01 00:00:00.000000'), with index condition: ((c.coupon_status = 'EXPIRED') and (c.issuable = false) and (c.issue_started_at &lt; TIMESTAMP'2019-02-01 00:00:00') and (c.issue_ended_at &gt; TIMESTAMP'2019-01-01 00:00:00'))  (cost=981 rows=2180) (actual time=0.0358..1.34 rows=8 loops=1)
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Index range scan</code>을 하고있고, 인덱스 범위 스캔의 조건으로 <code class="language-plaintext highlighter-rouge">issue_started_at</code>이 <code class="language-plaintext highlighter-rouge">NULL</code>보다 크고, <code class="language-plaintext highlighter-rouge">'2019-02-01 00:00:00.000000'</code>보다 작은 범위를 지정하고 있다. 인덱스 범위 스캔의 조건을 먼저 적용한 후, <code class="language-plaintext highlighter-rouge">index condition</code>에 명시된 조건들을 적용한다. <code class="language-plaintext highlighter-rouge">cost</code>는 981로 이전 커버링 인덱스보다 비용이 많이 늘어났다.</p>

<h3 id="범위-조건-우선하여-인덱스-설정하고-성능-테스트">범위 조건 우선하여 인덱스 설정하고 성능 테스트</h3>

<p>기존에 <code class="language-plaintext highlighter-rouge">issuable</code>, <code class="language-plaintext highlighter-rouge">coupon_status</code>를 먼저 설정한 인덱스를 지우고 테스트를 실행했다.</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">alter</span> <span class="k">table</span> <span class="n">coupon</span> <span class="k">drop</span> <span class="k">index</span> <span class="n">idx_issuable_coupon_status_issue_started_at_issue_ended_at</span><span class="p">;</span>
</code></pre></div></div>

<p><img src="/image/for-post/tommy-index/Pasted image 20240830170424.png" alt="[Pasted image 20240830170424.png]" /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Total</span> <span class="n">request</span> <span class="nl">count:</span> <span class="mi">329</span>
<span class="nc">Total</span> <span class="n">elapsed</span> <span class="nl">time:</span> <span class="mi">101617</span><span class="n">ms</span>
<span class="nc">Average</span> <span class="n">elapsed</span> <span class="nl">time:</span> <span class="mi">308</span><span class="n">ms</span>
</code></pre></div></div>

<p>3번 문제의 검증 조건이 요청 평균 소요 시간 <code class="language-plaintext highlighter-rouge">500ms</code> 이하라서 테스트에는 통과했지만, 이전 커버링 인덱스를 통한 요청 평균 소요 시간인 <code class="language-plaintext highlighter-rouge">7ms</code>과 비교해서 현재 <code class="language-plaintext highlighter-rouge">308ms</code>가 나왔으므로 성능이 <code class="language-plaintext highlighter-rouge">4285.71%</code> 떨어졌다. 왜 이렇게까지 효율이 많이 떨어졌을까?</p>

<h3 id="효율이-떨어진-이유">효율이 떨어진 이유</h3>

<p><code class="language-plaintext highlighter-rouge">Cardinality</code>가 높은 컬럼의 순서를 우선하도록 하여 성능이 더 좋아질 줄 알았는데 오히려 성능이 하락한 이유는 바로 인덱스의 첫 번째 컬럼인<code class="language-plaintext highlighter-rouge">issue_started_at</code>의 조건을 우선적으로 평가하기 때문이다. 근데 해당 컬럼은 <code class="language-plaintext highlighter-rouge">범위 조건</code>이기 때문에 인덱스 검색 방식을 변경한다. 사실 첫 번째가 아니더라도 <strong>범위 검색 조건 뒤에 오는 컬럼은 인덱스의 효율성을 잃게 된다.</strong> <a href="https://jojoldu.tistory.com/243">향로님의 인덱스 포스팅 참고</a></p>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">between</code>,<code class="language-plaintext highlighter-rouge">like</code>,<code class="language-plaintext highlighter-rouge">&lt;</code>,<code class="language-plaintext highlighter-rouge">&gt;</code> 등 <code class="language-plaintext highlighter-rouge">범위 조건</code>이 적용되면, 인덱스는 해당 범위 내의 모든 데이터를 검색하게 되므로, 이후 인덱스의 다른 컬럼들은 효율적으로 사용하지 못한다. 따라서, 위의 인덱스 기준으로<code class="language-plaintext highlighter-rouge">issue_started_at</code>조건 이후에 오는 <code class="language-plaintext highlighter-rouge">issue_ended_at</code>, <code class="language-plaintext highlighter-rouge">coupon_status</code>, <code class="language-plaintext highlighter-rouge">issuable</code> 컬럼은 인덱스에서 최적화되지 않고, 전체 데이터에서 필터링 하게 된다.</p>
</blockquote>

<p><code class="language-plaintext highlighter-rouge">Cardinality</code>가 높은 순서로 인덱스를 구성하는 것은 중요하지만, 인덱스 컬럼을 사용할 때 고정 조건이냐, 범위 조건이냐에 따라서 다르게 구성하는 것이 좋다. 데이터 상황에 따라서도 달라지겠지만, <code class="language-plaintext highlighter-rouge">Cardinality</code>가 높으면서 <code class="language-plaintext highlighter-rouge">고정 조건</code> 인덱스 컬럼을 앞에 배치하고, <code class="language-plaintext highlighter-rouge">범위 조건</code> 인덱스 컬럼을 뒤에 배치하는 것이 인덱스를 더 효율을 극대화 시킬 수 있는 방법이다. 위 경우에는 범위 조건이 <code class="language-plaintext highlighter-rouge">issue_started_at</code>, <code class="language-plaintext highlighter-rouge">issue_ended_at</code> 두 개 이기 때문에 둘 중 <code class="language-plaintext highlighter-rouge">Cardinality</code>가 더 높은 한 개만 추가하여 <code class="language-plaintext highlighter-rouge">coupon_status</code>, <code class="language-plaintext highlighter-rouge">issuable</code>, <code class="language-plaintext highlighter-rouge">issue_started_at</code> 이렇게 세 개의 컬럼으로 인덱스를 구성하는 것이 데이터 추가 시 인덱스 테이블에 데이터를 정렬하면서 발생하는 부담을 줄일 수 있을 것이다.</p>

<h3 id="쿼리에서-사용된-모든-컬럼에-대한-인덱스를-만드는-것이-좋을까">쿼리에서 사용된 모든 컬럼에 대한 인덱스를 만드는 것이 좋을까?</h3>

<p><a href="https://dev.mysql.com/doc/refman/8.0/en/optimization-indexes.html">MySQL Document</a></p>
<blockquote>
  <p>The best way to improve the performance of<a href="https://dev.mysql.com/doc/refman/8.0/en/select.html" title="15.2.13SELECT Statement"><code class="language-plaintext highlighter-rouge">SELECT</code></a>operations is to create indexes on one or more of the columns that are tested in the query. The index entries act like pointers to the table rows, allowing the query to quickly determine which rows match a condition in the<code class="language-plaintext highlighter-rouge">WHERE</code>clause, and retrieve the other column values for those rows. All MySQL data types can be indexed.
Although it can be tempting to create an indexes for every possible column used in a query, unnecessary indexes waste space and waste time for MySQL to determine which indexes to use. Indexes also add to the cost of inserts, updates, and deletes because each index must be updated. You must find the right balance to achieve fast queries using the optimal set of indexes.</p>
</blockquote>

<p>MySQL 문서에서도 언급하듯이, 불필요한 인덱스는 여러 가지 문제를 야기할 수 있다. 쿼리 성능을 개선하려면 최적의 인덱스 세트를 찾아야 한다. 이를 위해 <code class="language-plaintext highlighter-rouge">Cardinality</code>, 고정 조건과 범위 조건의 조합, 그리고 쿼리의 사용 패턴을 고려해야 한다. 모든 쿼리를 대상으로 커버링 인덱스를 구성하기보다는, 자주 사용되거나 성능이 중요한 쿼리를 분석하여 필요한 인덱스를 선택적으로 구성하는 것이 더 효율적이다.</p>

<h3 id="여러-컬럼으로-인덱스-설정-시-조건-누락">여러 컬럼으로 인덱스 설정 시 조건 누락</h3>

<p>인덱스가 여러 컬럼으로 구성되어 있을 때, 모든 컬럼을 조회 조건에 포함해야만 인덱스가 사용되는 것은 아니다. 어떤 컬럼은 누락될 수 있고, 어떤 컬럼은 반드시 포함되어야 인덱스를 효과적으로 사용할 수 있다.</p>

<p>인덱스 예시:<code class="language-plaintext highlighter-rouge">coupon_status</code>,<code class="language-plaintext highlighter-rouge">issuable</code>,<code class="language-plaintext highlighter-rouge">issue_started_at</code></p>

<ol>
  <li><strong>첫 번째 조회 쿼리</strong></li>
</ol>

<p>조건:<code class="language-plaintext highlighter-rouge">coupon_status</code>와<code class="language-plaintext highlighter-rouge">issuable</code>을 포함</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> 
<span class="k">FROM</span> <span class="n">coupons</span> 
<span class="k">WHERE</span> <span class="n">coupon_status</span> <span class="o">=</span> <span class="s1">'active'</span> <span class="k">AND</span> <span class="n">issuable</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</code></pre></div></div>
<p>인덱스를 정상적으로 사용함. (필터링 비율이 10%로 효율적이지는 않지만, 인덱스 사용 가능)</p>

<ol>
  <li><strong>두 번째 조회 쿼리</strong>:</li>
</ol>

<p>조건:<code class="language-plaintext highlighter-rouge">issuable</code>과<code class="language-plaintext highlighter-rouge">issue_started_at</code>만 포함,<code class="language-plaintext highlighter-rouge">coupon_status</code>제외</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> 
<span class="k">FROM</span> <span class="n">coupons</span> 
<span class="k">WHERE</span> <span class="n">issuable</span> <span class="o">=</span> <span class="k">true</span> <span class="k">AND</span> <span class="n">issue_started_at</span> <span class="o">&gt;=</span> <span class="s1">'2023-01-01'</span><span class="p">;</span>
</code></pre></div></div>
<p>인덱스를 전혀 사용하지 못함.</p>

<p>조회 쿼리를 작성할 때 인덱스를 효과적으로 사용하기 위해서는 반드시 첫 번째 인덱스 컬럼(예: <code class="language-plaintext highlighter-rouge">coupon_status</code>)이 포함되어야 한다. 첫 번째 컬럼이 누락되면 인덱스를 사용할 수 없다.</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> 태그: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#index" class="page__taxonomy-item" rel="tag">index</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#mysql" class="page__taxonomy-item" rel="tag">mysql</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> 카테고리: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#db" class="page__taxonomy-item" rel="tag">DB</a>
    
    </span>
  </p>


        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 업데이트:</strong> <time datetime="2024-08-30T00:00:00+09:00">August 30, 2024</time></p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">공유하기</h4>
  

  <a href="https://twitter.com/intent/tweet?text=%ED%86%A0%EB%AF%B8%EC%9D%98+Coupon+%EC%9D%B8%EB%8D%B1%EC%8A%A4+%EC%A0%95%EB%A6%AC+-+2%20http%3A%2F%2Flocalhost%3A4000%2Fdb%2F%25ED%2586%25A0%25EB%25AF%25B8%25EC%259D%2598-Coupon-%25EC%259D%25B8%25EB%258D%25B1%25EC%258A%25A4-%25EC%25A0%2595%25EB%25A6%25AC-2%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fdb%2F%25ED%2586%25A0%25EB%25AF%25B8%25EC%259D%2598-Coupon-%25EC%259D%25B8%25EB%258D%25B1%25EC%258A%25A4-%25EC%25A0%2595%25EB%25A6%25AC-2%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fdb%2F%25ED%2586%25A0%25EB%25AF%25B8%25EC%259D%2598-Coupon-%25EC%259D%25B8%25EB%258D%25B1%25EC%258A%25A4-%25EC%25A0%2595%25EB%25A6%25AC-2%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/db/%ED%86%A0%EB%AF%B8%EC%9D%98-Coupon-%EC%9D%B8%EB%8D%B1%EC%8A%A4-%EC%A0%95%EB%A6%AC-1/" class="pagination--pager" title="토미의 Coupon 인덱스 정리 - 1
">이전</a>
    
    
      <a href="#" class="pagination--pager disabled">다음</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">참고</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/db/%ED%86%A0%EB%AF%B8%EC%9D%98-Coupon-%EC%9D%B8%EB%8D%B1%EC%8A%A4-%EC%A0%95%EB%A6%AC-1/" rel="permalink">토미의 Coupon 인덱스 정리 - 1
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          13 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">토미의 트랜잭션, 인덱스 강의 자료를 학습하여 작성했다.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/woowacourse/A-collection-with-cascade=-all-delete-orphan-was-no-longer-referenced-by-the-owning-entity-instance-%EC%97%90%EB%9F%AC/" rel="permalink">org.hibernate.HibernateException: A collection with cascade=”all-delete-orphan” was no longer referenced by the owning entity instance 에러 트러블 슈팅
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">org.hibernate.HibernateException: A collection with cascade=”all-delete-orphan” was no longer referenced by the owning entity instance 에러 트러블 슈팅한 내용이다.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/woowacourse/%ED%96%89%EB%8F%99%EB%8C%80%EC%9E%A5-%EC%A0%95%EC%82%B0-%ED%8A%B9%ED%99%94-%EC%84%9C%EB%B9%84%EC%8A%A4%EB%A1%9C-%ED%83%88%EB%B0%94%EA%BF%88%EC%9D%84-%EC%9C%84%ED%95%9C-%EC%95%84%EC%9D%B4%EB%94%94%EC%96%B4/" rel="permalink">행동대장을 정산 특화 서비스로 탈바꿈 하기 위한 아이디어
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          1 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
  정산을 위해 지출 내용을 직접 입력해야 된다는 것 자체가 엄청나게 큰 허들.

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/db/sql-%ED%8C%8C%EC%9D%BC-%EC%9D%B4%EC%9A%A9%ED%95%B4%EC%84%9C-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EC%A0%80%EC%9E%A5/" rel="permalink">sql 파일 이용해서 데이터 저장하기
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          6 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">얼마 전 우테코의 코치 토미가 인덱스 강의를 해주셨다.
아마 토미가 미리 만들어두신 것으로 추정되는 백만에 가까운 row가 들어있는 대용량의 데이터를 바탕으로 강의가 진행되었다. 원래 수업시간 외에 크루들에게 데이터를 제공할 계획이 없으셨으나, 무수한 백엔드 크루들의 성원에 못이기...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>팔로우:</strong></li>
    

    
      
        
          <li><a href="mailto:gosmdochee2@gmail.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> Email</a></li>
        
      
        
      
        
      
        
          <li><a href="https://github.com/kunsanglee" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> 피드</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 Kunsang Lee. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







    
  <script>
    var disqus_config = function () {
      this.page.url = "http://localhost:4000/db/%ED%86%A0%EB%AF%B8%EC%9D%98-Coupon-%EC%9D%B8%EB%8D%B1%EC%8A%A4-%EC%A0%95%EB%A6%AC-2/";  /* Replace PAGE_URL with your page's canonical URL variable */
      this.page.identifier = "/db/토미의-Coupon-인덱스-정리-2"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */
    };
    (function() { /* DON'T EDIT BELOW THIS LINE */
      var d = document, s = d.createElement('script');
      s.src = 'https://https-kunsanglee-github-io.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  





  </body>
</html>
